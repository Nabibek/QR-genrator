<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse ‚Äî –ú–µ—Ö–∞–Ω–∏–∫</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f0f2f5;
            color: #1a1a2e;
            min-height: 100vh;
        }

        /* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
        .auth-overlay {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, #0f3460 0%, #16213e 50%, #1a1a2e 100%);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000;
        }
        .auth-card {
            background: white; border-radius: 16px;
            padding: 40px; width: 360px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .auth-card h2 { font-size: 22px; margin-bottom: 6px; }
        .auth-card p  { color: #666; font-size: 14px; margin-bottom: 24px; }

        /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
        .sidebar {
            position: fixed; left: 0; top: 0; bottom: 0; width: 220px;
            background: #1a1a2e; padding: 24px 0;
            display: flex; flex-direction: column;
        }
        .sidebar-logo {
            padding: 0 20px 24px;
            font-size: 16px; font-weight: 700; color: white;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-logo span { color: #3b82f6; }
        .nav-item {
            padding: 12px 20px; color: rgba(255,255,255,0.6);
            cursor: pointer; display: flex; align-items: center; gap: 10px;
            font-size: 14px; transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.05); }
        .nav-item.active { color: white; background: rgba(59,130,246,0.15); border-left-color: #3b82f6; }
        .nav-item .icon { font-size: 18px; width: 24px; text-align: center; }
        .sidebar-user {
            margin-top: auto; padding: 16px 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.5); font-size: 13px;
        }

        .main { margin-left: 220px; padding: 32px; }
        .page { display: none; }
        .page.active { display: block; }

        /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
        .page-header {
            display: flex; align-items: flex-start; justify-content: space-between;
            margin-bottom: 24px;
        }
        .page-title   { font-size: 24px; font-weight: 700; }
        .page-subtitle{ color: #666; font-size: 14px; margin-top: 4px; }

        .card {
            background: white; border-radius: 12px; padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 20px;
        }
        .card-title {
            font-size: 16px; font-weight: 600; margin-bottom: 20px;
            padding-bottom: 12px; border-bottom: 1px solid #f0f0f0;
            display: flex; align-items: center; gap: 8px;
        }

        /* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group.full { grid-column: 1 / -1; }
        .form-group label { font-size: 13px; font-weight: 500; color: #555; }
        .form-control {
            padding: 10px 14px; border: 1.5px solid #e0e0e0;
            border-radius: 8px; font-size: 14px; outline: none;
            transition: border-color 0.2s; width: 100%;
        }
        .form-control:focus { border-color: #3b82f6; }
        select.form-control { background: white; cursor: pointer; }
        textarea.form-control { resize: vertical; min-height: 72px; }

        /* ‚îÄ‚îÄ URGENCY TOGGLE ‚îÄ‚îÄ */
        .urgency-toggle { display: flex; gap: 10px; }
        .urgency-btn {
            flex: 1; padding: 10px; border: 2px solid #e0e0e0;
            border-radius: 8px; background: white; cursor: pointer;
            font-size: 14px; font-weight: 500; text-align: center;
            transition: all 0.2s;
        }
        .urgency-btn.normal.active  { border-color: #10b981; background: #f0fdf4; color: #10b981; }
        .urgency-btn.urgent.active  { border-color: #ef4444; background: #fef2f2; color: #ef4444; }

        /* ‚îÄ‚îÄ ITEMS LIST IN FORM ‚îÄ‚îÄ */
        .items-section { margin-top: 0; }
        .items-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 14px;
        }
        .items-title { font-size: 15px; font-weight: 600; }

        .item-row {
            background: #f8fafc; border: 1.5px solid #e8ecf0;
            border-radius: 10px; padding: 14px; margin-bottom: 10px;
            position: relative;
        }
        .item-row-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 12px;
        }
        .item-row-num {
            font-size: 12px; font-weight: 600; color: #888;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .item-row-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; }
        .item-row-grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }

        .search-dropdown {
            position: relative;
        }
        .search-results {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1.5px solid #e0e0e0;
            border-top: none; border-radius: 0 0 8px 8px;
            max-height: 180px; overflow-y: auto;
            z-index: 100; display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .search-results.show { display: block; }
        .search-result-item {
            padding: 10px 14px; cursor: pointer; font-size: 13px;
            transition: background 0.15s;
            border-bottom: 1px solid #f5f5f5;
        }
        .search-result-item:hover { background: #f0f7ff; }
        .search-result-item .res-name  { font-weight: 500; }
        .search-result-item .res-meta  { color: #888; font-size: 12px; margin-top: 2px; }
        .search-result-item.manual     { color: #3b82f6; font-style: italic; }
        .item-found-badge {
            display: inline-block; padding: 2px 8px;
            background: #f0fdf4; color: #16a34a;
            border-radius: 20px; font-size: 11px; font-weight: 500;
        }
        .item-notfound-badge {
            display: inline-block; padding: 2px 8px;
            background: #fff7ed; color: #ea580c;
            border-radius: 20px; font-size: 11px; font-weight: 500;
        }

        /* –§–æ—Ç–æ –¥–µ—Ç–∞–ª–∏ */
        .photo-mini {
            border: 2px dashed #e0e0e0; border-radius: 8px;
            padding: 10px; text-align: center; cursor: pointer;
            font-size: 12px; color: #888; position: relative;
            transition: all 0.2s; min-height: 44px;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .photo-mini:hover { border-color: #3b82f6; color: #3b82f6; }
        .photo-mini input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .photo-mini img   { max-height: 50px; border-radius: 4px; }

        /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
        .btn {
            padding: 10px 20px; border: none; border-radius: 8px;
            font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;
        }
        .btn-primary   { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: #f0f2f5; color: #333; }
        .btn-secondary:hover { background: #e0e2e5; }
        .btn-danger    { background: #fef2f2; color: #dc2626; }
        .btn-danger:hover { background: #fee2e2; }
        .btn-ghost  { background: none; border: 1.5px solid #e0e0e0; color: #666; }
        .btn-ghost:hover { border-color: #3b82f6; color: #3b82f6; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-add-item {
            width: 100%; padding: 12px; border: 2px dashed #c7d2fe;
            border-radius: 10px; background: #f5f7ff; color: #3b82f6;
            font-size: 14px; font-weight: 500; cursor: pointer;
            transition: all 0.2s; margin-top: 4px;
        }
        .btn-add-item:hover { border-color: #3b82f6; background: #eef2ff; }

        .form-actions {
            display: flex; gap: 12px; justify-content: flex-end;
            margin-top: 20px; padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }

        /* ‚îÄ‚îÄ ORDERS LIST ‚îÄ‚îÄ */
        .orders-grid { display: flex; flex-direction: column; gap: 14px; }
        .order-card {
            background: white; border-radius: 12px; padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border-left: 4px solid #e0e0e0;
            cursor: pointer; transition: all 0.2s;
        }
        .order-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); transform: translateY(-1px); }
        .order-card.urgent   { border-left-color: #ef4444; }
        .order-card.normal   { border-left-color: #3b82f6; }
        .order-card.ready    { border-left-color: #10b981; }
        .order-card.issued   { border-left-color: #8b5cf6; }

        .order-header {
            display: flex; align-items: flex-start; justify-content: space-between;
            margin-bottom: 10px;
        }
        .order-id    { font-size: 12px; color: #888; font-weight: 600; letter-spacing: 0.5px; }
        .order-title { font-size: 16px; font-weight: 600; margin-top: 2px; }
        .order-meta  { font-size: 13px; color: #666; margin-top: 4px; }

        .order-footer {
            display: flex; align-items: center; gap: 10px;
            margin-top: 12px; padding-top: 12px;
            border-top: 1px solid #f5f5f5;
        }
        .order-items-count { font-size: 13px; color: #888; }

        /* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
        .badge {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 4px 10px; border-radius: 20px;
            font-size: 12px; font-weight: 500; white-space: nowrap;
        }
        .badge-blue    { background: #eff6ff; color: #3b82f6; }
        .badge-green   { background: #f0fdf4; color: #16a34a; }
        .badge-red     { background: #fef2f2; color: #dc2626; }
        .badge-orange  { background: #fff7ed; color: #ea580c; }
        .badge-purple  { background: #f5f3ff; color: #7c3aed; }
        .badge-gray    { background: #f3f4f6; color: #6b7280; }

        /* ‚îÄ‚îÄ DETAIL VIEW ‚îÄ‚îÄ */
        .detail-header {
            display: flex; align-items: center; gap: 12px; margin-bottom: 24px;
        }
        .back-btn {
            padding: 8px 14px; background: #f0f2f5; border: none;
            border-radius: 8px; cursor: pointer; font-size: 14px;
            display: flex; align-items: center; gap: 6px;
        }
        .back-btn:hover { background: #e0e2e5; }

        .info-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px;
            margin-bottom: 20px;
        }
        .info-block {
            background: #f8fafc; border-radius: 8px; padding: 14px;
        }
        .info-label { font-size: 12px; color: #888; margin-bottom: 4px; }
        .info-value { font-size: 15px; font-weight: 600; }

        .detail-items table { width: 100%; border-collapse: collapse; }
        .detail-items th {
            text-align: left; padding: 10px 14px;
            font-size: 12px; color: #888; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.5px;
            border-bottom: 2px solid #f0f0f0;
        }
        .detail-items td {
            padding: 12px 14px; font-size: 14px;
            border-bottom: 1px solid #f7f7f7; vertical-align: middle;
        }

        /* ‚îÄ‚îÄ ALERT ‚îÄ‚îÄ */
        .alert {
            padding: 12px 16px; border-radius: 8px;
            font-size: 14px; margin-bottom: 16px; display: none;
        }
        .alert.show { display: block; }
        .alert-error   { background: #fef2f2; color: #dc2626; border: 1px solid #fee2e2; }
        .alert-success { background: #f0fdf4; color: #16a34a; border: 1px solid #dcfce7; }
        .alert-info    { background: #eff6ff; color: #3b82f6; border: 1px solid #dbeafe; }

        .empty-state {
            text-align: center; padding: 56px 20px; color: #aaa;
        }
        .empty-state .icon { font-size: 52px; margin-bottom: 14px; }
        .empty-state p { font-size: 15px; }

        /* ‚îÄ‚îÄ STATUS TIMELINE ‚îÄ‚îÄ */
        .timeline {
            display: flex; align-items: center; gap: 0;
            margin: 16px 0; overflow-x: auto; padding-bottom: 4px;
        }
        .tl-step {
            display: flex; flex-direction: column; align-items: center;
            min-width: 90px;
        }
        .tl-dot {
            width: 28px; height: 28px; border-radius: 50%;
            background: #e0e0e0; display: flex; align-items: center;
            justify-content: center; font-size: 13px; position: relative; z-index: 1;
        }
        .tl-dot.done   { background: #10b981; color: white; }
        .tl-dot.active { background: #3b82f6; color: white; box-shadow: 0 0 0 4px #dbeafe; }
        .tl-label { font-size: 11px; color: #888; margin-top: 6px; text-align: center; }
        .tl-line {
            flex: 1; height: 2px; background: #e0e0e0; min-width: 20px; margin-top: -14px;
        }
        .tl-line.done { background: #10b981; }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê -->
<div class="auth-overlay" id="authOverlay">
    <div class="auth-card">
        <h2>üîß –ö–∞–±–∏–Ω–µ—Ç –º–µ—Ö–∞–Ω–∏–∫–∞</h2>
        <p>–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–æ–∫ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π</p>
        <div class="form-group" style="margin-bottom:12px">
            <label>–õ–æ–≥–∏–Ω</label>
            <input type="text" id="authUsername" class="form-control" placeholder="operator1">
        </div>
        <div class="form-group" style="margin-bottom:20px">
            <label>–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="authPassword" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <div id="authAlert" class="alert alert-error"></div>
        <button class="btn btn-primary" style="width:100%" onclick="doLogin()">–í–æ–π—Ç–∏</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê -->
<div class="sidebar" id="sidebar" style="display:none">
    <div class="sidebar-logo">üîß –ú–µ—Ö–∞–Ω–∏–∫ <span>Portal</span></div>
    <div class="nav-item active" onclick="showPage('orders')" id="nav-orders">
        <span class="icon">üìã</span> –ú–æ–∏ –∑–∞—è–≤–∫–∏
    </div>
    <div class="nav-item" onclick="showPage('create')" id="nav-create">
        <span class="icon">‚ûï</span> –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞
    </div>
    <div class="sidebar-user">
        üë§ <span id="sidebarUser"></span><br>
        <a href="#" onclick="doLogout()" style="color:#3b82f6;font-size:12px">–í—ã—Ö–æ–¥</a>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê -->
<div class="main" id="mainContent" style="display:none">

    <!-- ‚îÄ‚îÄ –ú–û–ò –ó–ê–Ø–í–ö–ò ‚îÄ‚îÄ -->
    <div class="page active" id="page-orders">
        <div class="page-header">
            <div>
                <div class="page-title">–ú–æ–∏ –∑–∞—è–≤–∫–∏</div>
                <div class="page-subtitle">–ò—Å—Ç–æ—Ä–∏—è –∏ —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–æ–∫ –Ω–∞ –¥–µ—Ç–∞–ª–∏</div>
            </div>
            <button class="btn btn-primary" onclick="showPage('create')">‚ûï –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</button>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä—ã —Å—Ç–∞—Ç—É—Å–∞ -->
        <div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap">
            <button class="btn btn-sm badge badge-gray" style="cursor:pointer" onclick="filterOrders('')" id="filter-all">–í—Å–µ</button>
            <button class="btn btn-sm" onclick="filterOrders('pending')"   id="filter-pending">‚è≥ –û–∂–∏–¥–∞–µ—Ç</button>
            <button class="btn btn-sm" onclick="filterOrders('collecting')" id="filter-collecting">üì¶ –°–æ–±–∏—Ä–∞—é—Ç</button>
            <button class="btn btn-sm" onclick="filterOrders('ready')"     id="filter-ready">‚úÖ –ì–æ—Ç–æ–≤–æ</button>
            <button class="btn btn-sm" onclick="filterOrders('issued')"    id="filter-issued">ü§ù –í—ã–¥–∞–Ω–æ</button>
        </div>

        <div id="ordersList">
            <div class="empty-state"><div class="icon">üìã</div><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ –î–ï–¢–ê–õ–ò –ó–ê–Ø–í–ö–ò ‚îÄ‚îÄ -->
    <div class="page" id="page-detail">
        <div class="detail-header">
            <button class="back-btn" onclick="showPage('orders')">‚Üê –ù–∞–∑–∞–¥</button>
            <div>
                <div class="page-title" id="detailTitle">–ó–∞—è–≤–∫–∞</div>
                <div class="page-subtitle" id="detailSubtitle"></div>
            </div>
            <div id="detailBadge"></div>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å —Ç–∞–π–º–ª–∞–π–Ω -->
        <div class="card" style="padding:20px">
            <div class="timeline" id="detailTimeline"></div>
        </div>

        <!-- –ò–Ω—Ñ–æ -->
        <div class="info-grid" id="detailInfo"></div>

        <!-- –°–ø–∏—Å–æ–∫ –¥–µ—Ç–∞–ª–µ–π -->
        <div class="card">
            <div class="card-title">üì¶ –î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏</div>
            <div class="detail-items">
                <table>
                    <thead><tr>
                        <th>#</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ê—Ä—Ç–∏–∫—É–ª</th>
                        <th>–ö–æ–ª-–≤–æ</th><th>–ï–¥.</th><th>–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ</th><th>–§–æ—Ç–æ</th>
                    </tr></thead>
                    <tbody id="detailItemsTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ –°–û–ó–î–ê–¢–¨ –ó–ê–Ø–í–ö–£ ‚îÄ‚îÄ -->
    <div class="page" id="page-create">
        <div class="page-header">
            <div>
                <div class="page-title">–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</div>
                <div class="page-subtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π —Å–æ —Å–∫–ª–∞–¥–∞</div>
            </div>
        </div>

        <div id="createAlert" class="alert"></div>

        <!-- –ë–ª–æ–∫ 1: –¢–µ—Ö–Ω–∏–∫–∞ -->
        <div class="card">
            <div class="card-title">üöõ –¢–µ—Ö–Ω–∏–∫–∞ –∏ –≤–∏–¥ —Ä–∞–±–æ—Ç</div>
            <div class="form-grid">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–∏ / –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è *</label>
                    <input type="text" id="woEquipment" class="form-control" placeholder="–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä Komatsu PC200">
                </div>
                <div class="form-group">
                    <label>–ì–æ—Å. –Ω–æ–º–µ—Ä / –∏–Ω–≤. –Ω–æ–º–µ—Ä *</label>
                    <input type="text" id="woEquipmentNum" class="form-control" placeholder="–ê123–ë–í / –ò–ù–í-0042">
                </div>
                <div class="form-group">
                    <label>–¢–∏–ø —Ä–∞–±–æ—Ç—ã *</label>
                    <select id="woWorkType" class="form-control">
                        <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
                        <option value="–†–µ–º–æ–Ω—Ç">üîß –†–µ–º–æ–Ω—Ç</option>
                        <option value="–¢–û">üîÑ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ (–¢–û)</option>
                        <option value="–ó–∞–º–µ–Ω–∞">üîÅ –ó–∞–º–µ–Ω–∞ –¥–µ—Ç–∞–ª–∏</option>
                        <option value="–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞">üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</option>
                        <option value="–ê–≤–∞—Ä–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç">üö® –ê–≤–∞—Ä–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–°—Ä–æ—á–Ω–æ—Å—Ç—å</label>
                    <div class="urgency-toggle">
                        <button class="urgency-btn normal active" id="urgNormal" onclick="setUrgency('normal')">
                            üü¢ –û–±—ã—á–Ω–∞—è
                        </button>
                        <button class="urgency-btn urgent" id="urgUrgent" onclick="setUrgency('urgent')">
                            üî¥ –°—Ä–æ—á–Ω–∞—è
                        </button>
                    </div>
                </div>
                <div class="form-group full">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã / –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <textarea id="woDescription" class="form-control"
                        placeholder="–û–ø–∏—à–∏—Ç–µ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—å –∏–ª–∏ —á—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–¥–µ–ª–∞—Ç—å..."></textarea>
                </div>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ 2: –î–µ—Ç–∞–ª–∏ -->
        <div class="card">
            <div class="card-title">
                üì¶ –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–µ—Ç–∞–ª–∏
                <span style="font-size:12px;color:#888;font-weight:400;margin-left:8px">
                    –ú–∏–Ω–∏–º—É–º 1 –ø–æ–∑–∏—Ü–∏—è
                </span>
            </div>

            <div id="woItemsList"></div>

            <button class="btn-add-item" onclick="addItemRow()">
                + –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å
            </button>
        </div>

        <div class="form-actions">
            <button class="btn btn-secondary" onclick="resetCreateForm()">–û—á–∏—Å—Ç–∏—Ç—å</button>
            <button class="btn btn-primary" onclick="submitOrder()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
        </div>
    </div>

</div><!-- /main -->

<script>
const API = '/api';
let token = null;
let currentUser = null;
let currentUserId = null;
let urgency = 'normal';
let itemRowCount = 0;
let allOrders = [];
let catalogItems = [];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê
async function doLogin() {
    const username = document.getElementById('authUsername').value.trim();
    const password = document.getElementById('authPassword').value;
    const alertEl  = document.getElementById('authAlert');

    if (!username || !password) {
        showAlert(alertEl, '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å', 'error'); return;
    }

    try {
        const res  = await fetch(`${API}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        const data = await res.json();

        if (data.success) {
            token = data.token;
            currentUser   = data.username;
            currentUserId = data.user_id;
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('sidebar').style.display     = 'flex';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('sidebarUser').textContent   = currentUser;
            loadCatalog();
            loadOrders();
        } else {
            showAlert(alertEl, data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'error');
        }
    } catch(e) {
        showAlert(alertEl, '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
    }
}

function doLogout() {
    token = null;
    document.getElementById('sidebar').style.display     = 'none';
    document.getElementById('mainContent').style.display = 'none';
    document.getElementById('authOverlay').style.display = 'flex';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAV ‚ïê‚ïê
function showPage(name) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('page-' + name).classList.add('active');
    const nav = document.getElementById('nav-' + name);
    if (nav) nav.classList.add('active');

    if (name === 'orders') loadOrders();
    if (name === 'create' && itemRowCount === 0) addItemRow();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CATALOGUE ‚ïê‚ïê
async function loadCatalog() {
    try {
        const res  = await fetch(`${API}/admin/items`);
        const data = await res.json();
        catalogItems = data.items || [];
    } catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ORDERS ‚ïê‚ïê
async function loadOrders() {
    try {
        const res  = await fetch(`${API}/mechanic/orders`, {
            headers: { 'Authorization': token }
        });
        const data = await res.json();

        // –ï—Å–ª–∏ API –µ—â—ë –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
        if (!data.success) {
            renderOrders([]);
            return;
        }
        allOrders = data.orders || [];
        renderOrders(allOrders);
    } catch(e) {
        renderOrders([]);
    }
}

function filterOrders(status) {
    const filtered = status ? allOrders.filter(o => o.status === status) : allOrders;
    renderOrders(filtered);
}

function renderOrders(orders) {
    const container = document.getElementById('ordersList');
    if (!orders.length) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="icon">üìã</div>
                <p>–ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</p>
                <br>
                <button class="btn btn-primary" onclick="showPage('create')">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –∑–∞—è–≤–∫—É</button>
            </div>`;
        return;
    }

    container.innerHTML = `<div class="orders-grid">${orders.map(o => orderCardHTML(o)).join('')}</div>`;
}

function orderCardHTML(o) {
    const statusMap = {
        draft:      { label: '–ß–µ—Ä–Ω–æ–≤–∏–∫',  badge: 'badge-gray',   cls: '' },
        pending:    { label: '–û–∂–∏–¥–∞–µ—Ç',   badge: 'badge-blue',   cls: 'normal' },
        collecting: { label: '–°–æ–±–∏—Ä–∞—é—Ç',  badge: 'badge-orange', cls: 'normal' },
        ready:      { label: '–ì–æ—Ç–æ–≤–æ',    badge: 'badge-green',  cls: 'ready' },
        issued:     { label: '–í—ã–¥–∞–Ω–æ',    badge: 'badge-purple', cls: 'issued' },
    };
    const s = statusMap[o.status] || statusMap.pending;
    const urgClass = o.priority === 'urgent' ? 'urgent' : s.cls;

    return `
    <div class="order-card ${urgClass}" onclick="openOrder('${o.id}')">
        <div class="order-header">
            <div>
                <div class="order-id">${o.id}</div>
                <div class="order-title">${o.equipment} ‚Äî ${o.work_type}</div>
                <div class="order-meta">‚Ññ ${o.equipment_number} ¬∑ ${formatDate(o.created_at)}</div>
            </div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
                <span class="badge ${s.badge}">${s.label}</span>
                ${o.priority === 'urgent' ? '<span class="badge badge-red">üî¥ –°—Ä–æ—á–Ω–æ</span>' : ''}
            </div>
        </div>
        <div class="order-footer">
            <span class="order-items-count">üì¶ ${o.items_count || 0} –ø–æ–∑–∏—Ü–∏–π</span>
            ${o.status === 'ready' ? '<span class="badge badge-green">‚úÖ –ú–æ–∂–Ω–æ –∑–∞–±—Ä–∞—Ç—å!</span>' : ''}
        </div>
    </div>`;
}

function openOrder(id) {
    const o = allOrders.find(x => x.id === id);
    if (!o) return;

    document.getElementById('detailTitle').textContent    = `${o.equipment} ‚Äî ${o.work_type}`;
    document.getElementById('detailSubtitle').textContent = `–ó–∞—è–≤–∫–∞ ${o.id} ¬∑ ${formatDate(o.created_at)}`;

    const statusMap = {
        draft:      'badge-gray',
        pending:    'badge-blue',
        collecting: 'badge-orange',
        ready:      'badge-green',
        issued:     'badge-purple',
    };
    const statusLabel = {
        draft: '–ß–µ—Ä–Ω–æ–≤–∏–∫', pending: '–û–∂–∏–¥–∞–µ—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è',
        collecting: '–°–æ–±–∏—Ä–∞–µ—Ç—Å—è', ready: '–ì–æ—Ç–æ–≤–æ –∫ –≤—ã–¥–∞—á–µ', issued: '–í—ã–¥–∞–Ω–æ'
    };
    document.getElementById('detailBadge').innerHTML =
        `<span class="badge ${statusMap[o.status] || 'badge-gray'}">${statusLabel[o.status] || o.status}</span>`;

    // Timeline
    const steps = [
        { key: 'pending',    label: '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',  icon: 'üì§' },
        { key: 'collecting', label: '–°–±–æ—Ä–∫–∞',       icon: 'üì¶' },
        { key: 'ready',      label: '–ì–æ—Ç–æ–≤–æ',       icon: '‚úÖ' },
        { key: 'issued',     label: '–í—ã–¥–∞–Ω–æ',       icon: 'ü§ù' },
    ];
    const order_idx = steps.findIndex(s => s.key === o.status);
    let tlHTML = '';
    steps.forEach((s, i) => {
        const isDone   = i < order_idx;
        const isActive = i === order_idx;
        if (i > 0) tlHTML += `<div class="tl-line ${isDone ? 'done' : ''}"></div>`;
        tlHTML += `
            <div class="tl-step">
                <div class="tl-dot ${isDone ? 'done' : ''} ${isActive ? 'active' : ''}">${isDone ? '‚úì' : s.icon}</div>
                <div class="tl-label">${s.label}</div>
            </div>`;
    });
    document.getElementById('detailTimeline').innerHTML = tlHTML;

    // Info grid
    document.getElementById('detailInfo').innerHTML = `
        <div class="info-block">
            <div class="info-label">–¢–µ—Ö–Ω–∏–∫–∞</div>
            <div class="info-value">${o.equipment}</div>
        </div>
        <div class="info-block">
            <div class="info-label">–ì–æ—Å. / –∏–Ω–≤. –Ω–æ–º–µ—Ä</div>
            <div class="info-value">${o.equipment_number}</div>
        </div>
        <div class="info-block">
            <div class="info-label">–¢–∏–ø —Ä–∞–±–æ—Ç—ã</div>
            <div class="info-value">${o.work_type}</div>
        </div>
        <div class="info-block">
            <div class="info-label">–°—Ä–æ—á–Ω–æ—Å—Ç—å</div>
            <div class="info-value">${o.priority === 'urgent' ? 'üî¥ –°—Ä–æ—á–Ω–∞—è' : 'üü¢ –û–±—ã—á–Ω–∞—è'}</div>
        </div>
        <div class="info-block">
            <div class="info-label">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</div>
            <div class="info-value">${formatDate(o.created_at)}</div>
        </div>
        <div class="info-block">
            <div class="info-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
            <div class="info-value" style="font-size:13px;font-weight:400">${o.description || '‚Äî'}</div>
        </div>`;

    // Items table
    const items = o.items || [];
    document.getElementById('detailItemsTable').innerHTML = items.length
        ? items.map((item, i) => `
            <tr>
                <td style="color:#888">${i+1}</td>
                <td><strong>${item.name}</strong></td>
                <td style="color:#888">${item.part_number || '‚Äî'}</td>
                <td><strong>${item.quantity}</strong></td>
                <td>${item.unit || '—à—Ç'}</td>
                <td style="font-size:13px;color:#666">${item.justification || '‚Äî'}</td>
                <td>${item.photo_url ? `<img src="${item.photo_url}" style="height:40px;border-radius:4px">` : '‚Äî'}</td>
            </tr>`).join('')
        : '<tr><td colspan="7" style="text-align:center;color:#aaa;padding:20px">–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π</td></tr>';

    showPage('detail');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CREATE WO ‚ïê‚ïê
function setUrgency(val) {
    urgency = val;
    document.getElementById('urgNormal').classList.toggle('active', val === 'normal');
    document.getElementById('urgUrgent').classList.toggle('active', val === 'urgent');
}

function addItemRow() {
    itemRowCount++;
    const idx = itemRowCount;
    const div = document.createElement('div');
    div.className = 'item-row';
    div.id = `item-row-${idx}`;
    div.innerHTML = `
        <div class="item-row-header">
            <span class="item-row-num">–ü–æ–∑–∏—Ü–∏—è ${idx}</span>
            ${idx > 1 ? `<button class="btn btn-sm btn-danger" onclick="removeItemRow(${idx})">‚úï –£–¥–∞–ª–∏—Ç—å</button>` : ''}
        </div>
        <div class="item-row-grid">
            <!-- –ü–æ–∏—Å–∫ –¥–µ—Ç–∞–ª–∏ -->
            <div class="form-group">
                <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ *</label>
                <div class="search-dropdown">
                    <input type="text" class="form-control" id="iname-${idx}"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –∞—Ä—Ç–∏–∫—É–ª..."
                        oninput="searchCatalog(${idx}, this.value)"
                        onblur="hideResults(${idx})"
                        autocomplete="off">
                    <div class="search-results" id="iresults-${idx}"></div>
                </div>
                <input type="hidden" id="iitem_id-${idx}">
            </div>
            <div class="form-group">
                <label>–ö–∞—Ç–∞–ª–æ–∂–Ω—ã–π –Ω–æ–º–µ—Ä / –ê—Ä—Ç–∏–∫—É–ª</label>
                <input type="text" class="form-control" id="ipart-${idx}" placeholder="PN-2024-001">
            </div>
            <div class="form-group">
                <label>–ï–¥. –∏–∑–º–µ—Ä–µ–Ω–∏—è</label>
                <select class="form-control" id="iunit-${idx}">
                    <option value="—à—Ç">—à—Ç</option>
                    <option value="–∫–≥">–∫–≥</option>
                    <option value="–º">–º</option>
                    <option value="–ª">–ª</option>
                    <option value="—É–ø">—É–ø</option>
                    <option value="–∫–æ–º–ø–ª">–∫–æ–º–ø–ª</option>
                </select>
            </div>
        </div>
        <div class="item-row-grid2">
            <div class="form-group">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
                <input type="number" class="form-control" id="iqty-${idx}"
                    placeholder="1" min="1" value="1">
            </div>
            <div class="form-group">
                <label>–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏</label>
                <input type="text" class="form-control" id="ijust-${idx}"
                    placeholder="–ò–∑–Ω–æ—Å, –ø–ª–∞–Ω–æ–≤–∞—è –∑–∞–º–µ–Ω–∞, –ø–æ–ª–æ–º–∫–∞...">
            </div>
        </div>
        <!-- –§–æ—Ç–æ –¥–µ—Ç–∞–ª–∏ -->
        <div style="margin-top:10px">
            <label style="font-size:13px;font-weight:500;color:#555;display:block;margin-bottom:6px">
                –§–æ—Ç–æ –¥–µ—Ç–∞–ª–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
            </label>
            <div class="photo-mini" id="iphoto-area-${idx}">
                <input type="file" accept="image/*" onchange="previewItemPhoto(${idx}, this)">
                <span>üì∑ –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ</span>
                <img id="iphoto-preview-${idx}" style="display:none;max-height:60px;border-radius:4px">
            </div>
        </div>`;

    document.getElementById('woItemsList').appendChild(div);
}

function removeItemRow(idx) {
    document.getElementById(`item-row-${idx}`)?.remove();
}

// –ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É
function searchCatalog(idx, val) {
    const resultsEl = document.getElementById(`iresults-${idx}`);
    document.getElementById(`iitem_id-${idx}`).value = '';

    if (val.length < 2) { resultsEl.classList.remove('show'); return; }

    const q = val.toLowerCase();
    const matches = catalogItems.filter(i =>
        i.name.toLowerCase().includes(q) ||
        (i.sku && i.sku.toLowerCase().includes(q)) ||
        (i.part_number && i.part_number.toLowerCase().includes(q))
    ).slice(0, 6);

    let html = matches.map(i => `
        <div class="search-result-item" onmousedown="selectCatalogItem(${idx}, '${i.id}', '${escQ(i.name)}', '${escQ(i.part_number||'')}', '${i.unit||'—à—Ç'}')">
            <div class="res-name">${i.name}</div>
            <div class="res-meta">
                SKU: ${i.sku || '‚Äî'} ¬∑ –ê—Ä—Ç: ${i.part_number || '‚Äî'}
                ¬∑ –û—Å—Ç–∞—Ç–æ–∫: <strong>${i.quantity} ${i.unit || '—à—Ç'}</strong>
                ¬∑ ${i.location?.code || '–Ω–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ'}
            </div>
        </div>`).join('');

    // –û–ø—Ü–∏—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
    html += `<div class="search-result-item manual"
        onmousedown="selectManual(${idx}, '${escQ(val)}')">
        ‚úèÔ∏è –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é: "${val}"
    </div>`;

    resultsEl.innerHTML = html;
    resultsEl.classList.add('show');
}

function selectCatalogItem(idx, id, name, part, unit) {
    document.getElementById(`iname-${idx}`).value  = name;
    document.getElementById(`iitem_id-${idx}`).value = id;
    document.getElementById(`ipart-${idx}`).value  = part;
    document.getElementById(`iunit-${idx}`).value  = unit;
    document.getElementById(`iresults-${idx}`).classList.remove('show');
}

function selectManual(idx, name) {
    document.getElementById(`iname-${idx}`).value    = name;
    document.getElementById(`iitem_id-${idx}`).value = '';
    document.getElementById(`iresults-${idx}`).classList.remove('show');
}

function hideResults(idx) {
    setTimeout(() => {
        document.getElementById(`iresults-${idx}`)?.classList.remove('show');
    }, 200);
}

function previewItemPhoto(idx, input) {
    if (!input.files || !input.files[0]) return;
    const reader = new FileReader();
    reader.onload = e => {
        const img  = document.getElementById(`iphoto-preview-${idx}`);
        const area = document.getElementById(`iphoto-area-${idx}`);
        img.src = e.target.result;
        img.style.display = 'block';
        area.querySelector('span').style.display = 'none';
    };
    reader.readAsDataURL(input.files[0]);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SUBMIT ‚ïê‚ïê
async function submitOrder() {
    const alertEl   = document.getElementById('createAlert');
    const equipment = document.getElementById('woEquipment').value.trim();
    const eqNum     = document.getElementById('woEquipmentNum').value.trim();
    const workType  = document.getElementById('woWorkType').value;

    if (!equipment || !eqNum || !workType) {
        showAlert(alertEl, '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: —Ç–µ—Ö–Ω–∏–∫–∞, –Ω–æ–º–µ—Ä –∏ —Ç–∏–ø —Ä–∞–±–æ—Ç—ã', 'error');
        alertEl.scrollIntoView({ behavior: 'smooth' });
        return;
    }

    // –°–æ–±–∏—Ä–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏
    const items = [];
    for (let i = 1; i <= itemRowCount; i++) {
        const row = document.getElementById(`item-row-${i}`);
        if (!row) continue;
        const name = document.getElementById(`iname-${i}`)?.value.trim();
        const qty  = parseInt(document.getElementById(`iqty-${i}`)?.value) || 0;
        if (!name) continue;
        items.push({
            item_id:       document.getElementById(`iitem_id-${i}`)?.value || '',
            name,
            part_number:   document.getElementById(`ipart-${i}`)?.value || '',
            unit:          document.getElementById(`iunit-${i}`)?.value || '—à—Ç',
            quantity:      qty,
            justification: document.getElementById(`ijust-${i}`)?.value || '',
        });
    }

    if (!items.length) {
        showAlert(alertEl, '–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –¥–µ—Ç–∞–ª—å', 'error');
        return;
    }

    const payload = {
        equipment,
        equipment_number: eqNum,
        work_type:        workType,
        priority:         urgency,
        description:      document.getElementById('woDescription').value,
        mechanic_id:      currentUserId,
        items
    };

    try {
        const res  = await fetch(`${API}/mechanic/order`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token
            },
            body: JSON.stringify(payload)
        });
        const data = await res.json();

        if (data.success) {
            showAlert(alertEl, `‚úÖ –ó–∞—è–≤–∫–∞ ${data.order_id} —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!`, 'success');
            resetCreateForm();
            setTimeout(() => showPage('orders'), 1500);
        } else {
            showAlert(alertEl, data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏', 'error');
        }
    } catch(e) {
        // API –µ—â—ë –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –¥–µ–º–æ
        showAlert(alertEl,
            '‚úÖ –ó–∞—è–≤–∫–∞ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞ (API /mechanic/order –µ—â—ë –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–∞ –±—ç–∫–µ–Ω–¥–µ)',
            'success');
    }
}

function resetCreateForm() {
    document.getElementById('woEquipment').value    = '';
    document.getElementById('woEquipmentNum').value = '';
    document.getElementById('woWorkType').value     = '';
    document.getElementById('woDescription').value  = '';
    setUrgency('normal');
    document.getElementById('woItemsList').innerHTML = '';
    itemRowCount = 0;
    addItemRow();
    hideAlert(document.getElementById('createAlert'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê
function showAlert(el, msg, type) {
    el.textContent = msg;
    el.className = `alert alert-${type} show`;
}
function hideAlert(el) {
    if (!el) return;
    el.className = 'alert';
    el.textContent = '';
}
function formatDate(str) {
    if (!str) return '‚Äî';
    return new Date(str).toLocaleString('ru-RU', {
        day:'2-digit', month:'2-digit', year:'numeric',
        hour:'2-digit', minute:'2-digit'
    });
}
function escQ(s) {
    return (s || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

// Enter –Ω–∞ –ª–æ–≥–∏–Ω–µ
document.addEventListener('keydown', e => {
    if (e.key === 'Enter' && document.getElementById('authOverlay').style.display !== 'none') {
        doLogin();
    }
});
</script>
</body>
</html>