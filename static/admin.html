<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse ‚Äî –ö–ª–∞–¥–æ–≤—â–∏–∫ / –ê–¥–º–∏–Ω</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f0f2f5; color: #1a1a2e; min-height: 100vh; }
        .auth-overlay { position: fixed; inset: 0; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .auth-card { background: white; border-radius: 16px; padding: 40px; width: 360px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .auth-card h2 { font-size: 22px; margin-bottom: 8px; }
        .auth-card p  { color: #666; font-size: 14px; margin-bottom: 24px; }
        .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 230px; background: #1a1a2e; padding: 24px 0; display: flex; flex-direction: column; z-index: 100; }
        .sidebar-logo { padding: 0 20px 20px; font-size: 16px; font-weight: 700; color: white; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-logo span { color: #e94560; }
        .sidebar-section { padding: 14px 20px 6px; font-size: 10px; color: rgba(255,255,255,0.3); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .nav-item { padding: 11px 20px; color: rgba(255,255,255,0.6); cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 14px; transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.05); }
        .nav-item.active { color: white; background: rgba(233,69,96,0.15); border-left-color: #e94560; }
        .nav-item .icon { font-size: 17px; width: 22px; text-align: center; }
        .nav-badge { margin-left: auto; background: #e94560; color: white; border-radius: 10px; padding: 1px 7px; font-size: 11px; font-weight: 700; }
        .sidebar-user { margin-top: auto; padding: 16px 20px; border-top: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); font-size: 13px; }
        .main { margin-left: 230px; padding: 28px 32px; }
        .page { display: none; }
        .page.active { display: block; }
        .page-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 24px; }
        .page-title { font-size: 24px; font-weight: 700; }
        .page-subtitle { color: #666; font-size: 14px; margin-top: 4px; }
        .card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 20px; }
        .card-title { font-size: 15px; font-weight: 600; margin-bottom: 18px; padding-bottom: 12px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 8px; }
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 14px; margin-bottom: 24px; }
        .stat-card { background: white; border-radius: 12px; padding: 18px 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .stat-label { font-size: 12px; color: #888; margin-bottom: 6px; }
        .stat-value { font-size: 26px; font-weight: 700; }
        .stat-sub   { font-size: 11px; color: #aaa; margin-top: 3px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group.full { grid-column: 1 / -1; }
        .form-group label { font-size: 13px; font-weight: 500; color: #555; }
        .form-control { padding: 10px 14px; border: 1.5px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.2s; outline: none; width: 100%; }
        .form-control:focus { border-color: #e94560; }
        select.form-control { background: white; cursor: pointer; }
        textarea.form-control { resize: vertical; min-height: 80px; }
        .photo-upload { border: 2px dashed #e0e0e0; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; }
        .photo-upload:hover { border-color: #e94560; background: #fff5f7; }
        .photo-upload input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .photo-upload .upload-icon { font-size: 28px; margin-bottom: 8px; }
        .photo-upload p { font-size: 13px; color: #888; }
        .photo-preview { max-width: 100%; max-height: 120px; border-radius: 6px; margin-top: 10px; display: none; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary   { background: #e94560; color: white; }
        .btn-primary:hover { background: #c73652; }
        .btn-secondary { background: #f0f2f5; color: #333; }
        .btn-secondary:hover { background: #e0e2e5; }
        .btn-success   { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-warning   { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-blue      { background: #3b82f6; color: white; }
        .btn-blue:hover { background: #2563eb; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .form-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; padding-top: 20px; border-top: 1px solid #f0f0f0; }
        .table-controls { display: flex; gap: 12px; margin-bottom: 16px; align-items: center; flex-wrap: wrap; }
        .search-input { padding: 9px 14px; border: 1.5px solid #e0e0e0; border-radius: 8px; font-size: 14px; outline: none; width: 250px; transition: border-color 0.2s; }
        .search-input:focus { border-color: #e94560; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px 14px; font-size: 11px; font-weight: 600; color: #888; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #f0f0f0; }
        td { padding: 12px 14px; font-size: 14px; border-bottom: 1px solid #f7f7f7; vertical-align: middle; }
        tr:hover td { background: #fafafa; }
        .badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; white-space: nowrap; }
        .badge-blue   { background: #eff6ff; color: #3b82f6; }
        .badge-green  { background: #f0fdf4; color: #16a34a; }
        .badge-gray   { background: #f3f4f6; color: #6b7280; }
        .badge-red    { background: #fef2f2; color: #dc2626; }
        .badge-orange { background: #fff7ed; color: #ea580c; }
        .badge-purple { background: #f5f3ff; color: #7c3aed; }
        .badge-yellow { background: #fefce8; color: #ca8a04; }
        .qty { font-weight: 600; }
        .qty.low { color: #ef4444; }
        .alert { padding: 12px 16px; border-radius: 8px; font-size: 14px; margin-bottom: 16px; display: none; }
        .alert.show { display: block; }
        .alert-error   { background: #fef2f2; color: #dc2626; border: 1px solid #fee2e2; }
        .alert-success { background: #f0fdf4; color: #16a34a; border: 1px solid #dcfce7; }
        .alert-info    { background: #eff6ff; color: #3b82f6; border: 1px solid #dbeafe; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 500; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 16px; padding: 32px; width: 420px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
        .modal-icon { font-size: 48px; margin-bottom: 16px; }
        .modal h3 { font-size: 20px; margin-bottom: 8px; }
        .modal p { color: #666; font-size: 14px; margin-bottom: 20px; }
        .qr-preview { width: 180px; height: 180px; border-radius: 8px; margin: 0 auto 20px; display: block; border: 1px solid #e0e0e0; }
        .empty-state { text-align: center; padding: 48px 20px; color: #aaa; }
        .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
        .orders-filters { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn { padding: 7px 16px; border: 1.5px solid #e0e0e0; border-radius: 20px; background: white; font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .filter-btn:hover { border-color: #e94560; color: #e94560; }
        .filter-btn.active { background: #e94560; color: white; border-color: #e94560; }
        .order-row { display: flex; align-items: center; padding: 16px; border-bottom: 1px solid #f5f5f5; gap: 14px; cursor: pointer; transition: background 0.15s; }
        .order-row:hover { background: #fafafa; }
        .order-row:last-child { border-bottom: none; }
        .order-priority-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .order-priority-dot.urgent { background: #ef4444; box-shadow: 0 0 0 3px #fee2e2; }
        .order-priority-dot.normal { background: #10b981; }
        .order-info { flex: 1; min-width: 0; }
        .order-title { font-weight: 600; font-size: 15px; }
        .order-meta  { font-size: 12px; color: #888; margin-top: 3px; }
        .order-actions { display: flex; gap: 8px; flex-shrink: 0; }
        .assembly-header { background: white; border-radius: 12px; padding: 20px 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); display: flex; align-items: center; gap: 16px; }
        .assembly-back { padding: 8px 14px; background: #f0f2f5; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .assembly-back:hover { background: #e0e2e5; }
        .assembly-title { flex: 1; }
        .assembly-title h2 { font-size: 18px; font-weight: 700; }
        .assembly-title p  { font-size: 13px; color: #666; margin-top: 2px; }
        .assembly-progress { background: white; border-radius: 12px; padding: 16px 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .progress-bar-wrap { background: #f0f2f5; border-radius: 8px; height: 10px; margin: 10px 0 6px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #10b981, #34d399); border-radius: 8px; transition: width 0.4s; }
        .assembly-item { background: white; border-radius: 10px; padding: 16px 20px; margin-bottom: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); display: flex; align-items: center; gap: 14px; transition: all 0.2s; border-left: 4px solid transparent; }
        .assembly-item.collected { border-left-color: #10b981; opacity: 0.75; }
        .assembly-item.not-found { border-left-color: #ef4444; }
        .assembly-item-check { width: 28px; height: 28px; border-radius: 50%; border: 2px solid #e0e0e0; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; cursor: pointer; transition: all 0.2s; }
        .assembly-item-check.done { background: #10b981; border-color: #10b981; color: white; }
        .assembly-item-check.nf   { background: #ef4444; border-color: #ef4444; color: white; }
        .assembly-item-info { flex: 1; }
        .assembly-item-name { font-weight: 600; font-size: 15px; }
        .assembly-item-meta { font-size: 13px; color: #666; margin-top: 3px; }
        .assembly-item-location { display: inline-flex; align-items: center; gap: 5px; background: #eff6ff; color: #3b82f6; padding: 3px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        .assembly-item-qty { text-align: right; flex-shrink: 0; min-width: 50px; }
        .assembly-item-qty .need  { font-size: 18px; font-weight: 700; }
        .assembly-item-qty .unit  { font-size: 12px; color: #888; }
        .assembly-item-actions { display: flex; gap: 6px; flex-shrink: 0; }
        .scanner-modal { width: 480px; }
        .scanner-video-wrap { position: relative; background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 16px; }
        .scanner-video-wrap video { width: 100%; display: block; max-height: 280px; object-fit: cover; }
        .scanner-video-wrap canvas { display: none; }
        .scanner-frame-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .scanner-frame-box { width: 180px; height: 180px; border: 3px solid #e94560; border-radius: 12px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.45); }
        .scanner-result { background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 12px 16px; font-size: 14px; color: #15803d; display: none; margin-bottom: 12px; }
        .scanner-result.show { display: block; }
        .issue-qr-img { width: 200px; height: 200px; border-radius: 10px; margin: 0 auto 12px; display: block; border: 2px solid #e0e0e0; }
        .issuance-order-info { background: #f8fafc; border-radius: 10px; padding: 16px; margin: 16px 0; text-align: left; }
        .issuance-order-info table { width: 100%; }
        .issuance-order-info td { padding: 5px 0; font-size: 14px; border: none; }
        .issuance-order-info td:first-child { color: #888; width: 140px; }
        .issuance-order-info td:last-child { font-weight: 600; }
    </style>
</head>
<body>

<div class="auth-overlay" id="authOverlay">
    <div class="auth-card">
        <h2>üè≠ –ü–∞–Ω–µ–ª—å —Å–∫–ª–∞–¥–∞</h2>
        <p>–ö–ª–∞–¥–æ–≤—â–∏–∫ / –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</p>
        <div class="form-group" style="margin-bottom:12px"><label>–õ–æ–≥–∏–Ω</label><input type="text" id="authUsername" class="form-control" value="admin" placeholder="admin"></div>
        <div class="form-group" style="margin-bottom:20px"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="authPassword" class="form-control" value="admin123" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
        <div id="authAlert" class="alert alert-error"></div>
        <button class="btn btn-primary" style="width:100%" onclick="adminLogin()">–í–æ–π—Ç–∏</button>
    </div>
</div>

<div class="sidebar" id="sidebar" style="display:none">
    <div class="sidebar-logo">üì¶ Warehouse <span>WMS</span></div>
    <div class="sidebar-section">–°–∫–ª–∞–¥</div>
    <div class="nav-item active" onclick="showPage('dashboard')" id="nav-dashboard"><span class="icon">üìä</span> –î–∞—à–±–æ—Ä–¥</div>
    <div class="nav-item" onclick="showPage('orders')" id="nav-orders"><span class="icon">üìã</span> –û—á–µ—Ä–µ–¥—å –∑–∞—è–≤–æ–∫ <span class="nav-badge" id="pendingBadge" style="display:none">0</span></div>
    <div class="nav-item" onclick="showPage('issuance')" id="nav-issuance"><span class="icon">üì§</span> –í—ã–¥–∞—á–∞</div>
    <div class="sidebar-section">–ö–∞—Ç–∞–ª–æ–≥</div>
    <div class="nav-item" onclick="showPage('create-item')" id="nav-create-item"><span class="icon">‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</div>
    <div class="nav-item" onclick="showPage('items')" id="nav-items"><span class="icon">üóÇÔ∏è</span> –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</div>
    <div class="nav-item" onclick="showPage('locations')" id="nav-locations"><span class="icon">üìç</span> –õ–æ–∫–∞—Ü–∏–∏</div>
    <div class="sidebar-user">üë§ <span id="sidebarUser"></span><br><a href="#" onclick="adminLogout()" style="color:#e94560;font-size:12px">–í—ã—Ö–æ–¥</a></div>
</div>

<div class="main" id="mainContent" style="display:none">

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
        <div class="page-header"><div><div class="page-title">–î–∞—à–±–æ—Ä–¥</div><div class="page-subtitle">–û–±–∑–æ—Ä —Å–∫–ª–∞–¥–∞</div></div></div>
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">–¢–æ–≤–∞—Ä–æ–≤</div><div class="stat-value" id="statItems">‚Äî</div><div class="stat-sub">–ø–æ–∑–∏—Ü–∏–π</div></div>
            <div class="stat-card"><div class="stat-label">–õ–æ–∫–∞—Ü–∏–π</div><div class="stat-value" id="statLocations">‚Äî</div><div class="stat-sub">—è—á–µ–µ–∫</div></div>
            <div class="stat-card"><div class="stat-label">–ú–∞–ª–æ –Ω–∞ —Å–∫–ª–∞–¥–µ</div><div class="stat-value" style="color:#ef4444" id="statLow">‚Äî</div><div class="stat-sub">–º–µ–Ω–µ–µ 5 –µ–¥–∏–Ω–∏—Ü</div></div>
            <div class="stat-card"><div class="stat-label">–ó–∞—è–≤–æ–∫ –≤ —Ä–∞–±–æ—Ç–µ</div><div class="stat-value" style="color:#f59e0b" id="statOrders">‚Äî</div><div class="stat-sub">–æ–∂–∏–¥–∞—é—Ç —Å–±–æ—Ä–∫–∏</div></div>
            <div class="stat-card"><div class="stat-label">–ì–æ—Ç–æ–≤–æ –∫ –≤—ã–¥–∞—á–µ</div><div class="stat-value" style="color:#10b981" id="statReady">‚Äî</div><div class="stat-sub">–º–æ–∂–Ω–æ –∑–∞–±—Ä–∞—Ç—å</div></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
            <div class="card"><div class="card-title">‚ö° –°—Ä–æ—á–Ω—ã–µ –∑–∞—è–≤–∫–∏</div><div id="urgentOrdersList"><div class="empty-state" style="padding:20px"><div class="icon">‚úÖ</div>–°—Ä–æ—á–Ω—ã—Ö –Ω–µ—Ç</div></div></div>
            <div class="card"><div class="card-title">üì¶ –ú–∞–ª–æ –Ω–∞ —Å–∫–ª–∞–¥–µ</div>
                <table><thead><tr><th>–¢–æ–≤–∞—Ä</th><th>–û—Å—Ç–∞—Ç–æ–∫</th><th>–õ–æ–∫–∞—Ü–∏—è</th></tr></thead>
                <tbody id="lowStockTable"><tr><td colspan="3" style="text-align:center;color:#aaa;padding:20px">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody></table>
            </div>
        </div>
    </div>

    <!-- ORDERS QUEUE -->
    <div class="page" id="page-orders">
        <div class="page-header">
            <div><div class="page-title">–û—á–µ—Ä–µ–¥—å –∑–∞—è–≤–æ–∫</div><div class="page-subtitle">–ó–∞—è–≤–∫–∏ –æ—Ç –º–µ—Ö–∞–Ω–∏–∫–æ–≤ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π</div></div>
            <button class="btn btn-secondary" onclick="loadOrders()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div class="orders-filters">
            <button class="filter-btn active" onclick="filterOrders('',this)">–í—Å–µ</button>
            <button class="filter-btn" onclick="filterOrders('pending',this)">‚è≥ –û–∂–∏–¥–∞—é—Ç</button>
            <button class="filter-btn" onclick="filterOrders('collecting',this)">üîß –í —Å–±–æ—Ä–∫–µ</button>
            <button class="filter-btn" onclick="filterOrders('ready',this)">‚úÖ –ì–æ—Ç–æ–≤—ã</button>
            <button class="filter-btn" onclick="filterOrders('issued',this)">üì§ –í—ã–¥–∞–Ω–æ</button>
        </div>
        <div class="card" style="padding:0"><div id="ordersList"><div class="empty-state"><div class="icon">üìã</div><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div></div></div>
    </div>

    <!-- ASSEMBLY -->
    <div class="page" id="page-assembly">
        <div class="assembly-header">
            <button class="assembly-back" onclick="showPage('orders')">‚Üê –ù–∞–∑–∞–¥</button>
            <div class="assembly-title"><h2 id="assemblyTitle">–°–±–æ—Ä–∫–∞ –∑–∞—è–≤–∫–∏</h2><p id="assemblySubtitle"></p></div>
            <div id="assemblyBadge"></div>
        </div>
        <div class="assembly-progress">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <strong style="font-size:15px">–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±–æ—Ä–∫–∏</strong>
                <span id="progressText" style="font-size:14px;color:#666">0 –∏–∑ 0</span>
            </div>
            <div class="progress-bar-wrap"><div class="progress-bar-fill" id="progressBar" style="width:0%"></div></div>
            <div style="display:flex;justify-content:space-between;font-size:13px;color:#666;margin-top:4px">
                <span>üü¢ <span id="collectedCount">0</span> —Å–æ–±—Ä–∞–Ω–æ</span>
                <span>üî¥ <span id="notFoundCount">0</span> –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</span>
                <span>‚¨ú <span id="pendingCount">0</span> –æ—Å—Ç–∞–ª–æ—Å—å</span>
            </div>
        </div>
        <div id="assemblyItemsList"></div>
        <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:8px">
            <button class="btn btn-secondary" onclick="startScanForAssembly()">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —è—á–µ–π–∫—É</button>
            <button class="btn btn-warning" id="btnFinishAssembly" onclick="finishAssembly()" disabled>‚ö†Ô∏è –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–±–æ—Ä–∫—É</button>
            <button class="btn btn-success" id="btnCompleteAssembly" onclick="completeAssembly()" style="display:none">‚úÖ –í—Å—ë —Å–æ–±—Ä–∞–Ω–æ ‚Äî –ì–æ—Ç–æ–≤–æ</button>
        </div>
    </div>

    <!-- ISSUANCE -->
    <div class="page" id="page-issuance">
        <div class="page-header"><div><div class="page-title">–í—ã–¥–∞—á–∞ –¥–µ—Ç–∞–ª–µ–π</div><div class="page-subtitle">–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∑–∞—è–≤–∫–∏ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –º–µ—Ö–∞–Ω–∏–∫–∞</div></div></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
            <div class="card" style="text-align:center">
                <div class="card-title" style="justify-content:center">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR –∑–∞—è–≤–∫–∏</div>
                <p style="color:#666;font-size:14px;margin-bottom:20px">–ú–µ—Ö–∞–Ω–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç QR –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ ‚Äî –Ω–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É</p>
                <div class="scanner-video-wrap" id="issuanceScannerWrap" style="display:none">
                    <video id="issuanceVideo" playsinline autoplay muted></video>
                    <canvas id="issuanceCanvas"></canvas>
                    <div class="scanner-frame-overlay"><div class="scanner-frame-box"></div></div>
                </div>
                <div class="scanner-result" id="issuanceScanResult"></div>
                <button class="btn btn-primary" id="btnStartIssuanceScan" onclick="startIssuanceScan()" style="width:200px">üì∑ –û—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É</button>
                <button class="btn btn-secondary" id="btnStopIssuanceScan" onclick="stopIssuanceScan()" style="width:200px;display:none">‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                <div style="margin-top:16px;color:#aaa;font-size:13px">‚Äî –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ ID –≤—Ä—É—á–Ω—É—é ‚Äî</div>
                <div style="display:flex;gap:8px;margin-top:10px">
                    <input type="text" id="manualOrderId" class="form-control" placeholder="WO-20240226-XXXX">
                    <button class="btn btn-blue btn-sm" onclick="lookupOrderForIssuance(document.getElementById('manualOrderId').value)">–ù–∞–π—Ç–∏</button>
                </div>
            </div>
            <div id="issuanceResultPanel">
                <div style="display:none;background:white;border-radius:12px;padding:28px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.06)" id="issuanceOrderCard">
                    <div style="font-size:56px;margin-bottom:12px" id="issuanceIcon">üì¶</div>
                    <h3 id="issuanceOrderTitle" style="margin-bottom:12px"></h3>
                    <div class="issuance-order-info">
                        <table><tr><td>ID –∑–∞—è–≤–∫–∏</td><td id="iss-id"></td></tr><tr><td>–¢–µ—Ö–Ω–∏–∫–∞</td><td id="iss-equipment"></td></tr><tr><td>–¢–∏–ø —Ä–∞–±–æ—Ç—ã</td><td id="iss-worktype"></td></tr><tr><td>–ü–æ–∑–∏—Ü–∏–π</td><td id="iss-items"></td></tr><tr><td>–°—Ç–∞—Ç—É—Å</td><td id="iss-status"></td></tr></table>
                    </div>
                    <div id="issuanceActions"></div>
                </div>
                <div class="empty-state" id="issuanceEmpty"><div class="icon">üîç</div><p>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∑–∞—è–≤–∫–∏<br>–∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ ID –≤—Ä—É—á–Ω—É—é</p></div>
            </div>
        </div>
    </div>

    <!-- CREATE ITEM -->
    <div class="page" id="page-create-item">
        <div class="page-header"><div><div class="page-title">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</div><div class="page-subtitle">QR —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</div></div></div>
        <div id="createAlert" class="alert"></div>
        <div class="card">
            <div class="card-title">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
            <div class="form-grid">
                <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label><input type="text" id="itemName" class="form-control" placeholder="–ë–æ–ª—Ç –ú10 x 50"></div>
                <div class="form-group"><label>SKU *</label><input type="text" id="itemSku" class="form-control" placeholder="SKU-001"></div>
                <div class="form-group"><label>–ê—Ä—Ç–∏–∫—É–ª (Part Number)</label><input type="text" id="itemPartNumber" class="form-control" placeholder="PN-2024-001"></div>
                <div class="form-group"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><input type="text" id="itemCategory" class="form-control" placeholder="–ö—Ä–µ–ø—ë–∂, –§–∏–ª—å—Ç—Ä—ã..." list="categoryList"><datalist id="categoryList"></datalist></div>
                <div class="form-group"><label>–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</label>
                    <select id="itemUnit" class="form-control"><option value="—à—Ç">—à—Ç ‚Äî —à—Ç—É–∫–∞</option><option value="–∫–≥">–∫–≥ ‚Äî –∫–∏–ª–æ–≥—Ä–∞–º–º</option><option value="–º">–º ‚Äî –º–µ—Ç—Ä</option><option value="–ª">–ª ‚Äî –ª–∏—Ç—Ä</option><option value="—É–ø">—É–ø ‚Äî —É–ø–∞–∫–æ–≤–∫–∞</option><option value="–∫–æ–º–ø–ª">–∫–æ–º–ø–ª ‚Äî –∫–æ–º–ø–ª–µ–∫—Ç</option></select>
                </div>
                <div class="form-group"><label>–õ–æ–∫–∞—Ü–∏—è –Ω–∞ —Å–∫–ª–∞–¥–µ</label><select id="itemLocation" class="form-control"><option value="">‚Äî –ù–µ —É–∫–∞–∑–∞–Ω–∞ ‚Äî</option></select></div>
                <div class="form-group full"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="itemDescription" class="form-control" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ..."></textarea></div>
            </div>
        </div>
        <div class="card">
            <div class="card-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞—Ä—Ç–∏–∏</div>
            <div class="form-grid">
                <div class="form-group"><label>–ù–æ–º–µ—Ä –ø–∞—Ä—Ç–∏–∏</label><input type="text" id="itemBatchNumber" class="form-control" placeholder="BATCH-2024-01"></div>
                <div class="form-group"><label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –ø–∞—Ä—Ç–∏–∏</label><input type="number" id="itemBatchQty" class="form-control" placeholder="100" min="0"></div>
                <div class="form-group"><label>–¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫</label><input type="number" id="itemQuantity" class="form-control" placeholder="100" min="0"></div>
                <div class="form-group"><label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø—Ä–∏—Ö–æ–¥–∞</label><input type="datetime-local" id="itemArrivedAt" class="form-control"></div>
            </div>
        </div>
        <div class="card">
            <div class="card-title">–§–æ—Ç–æ –Ω–∞–∫–ª–∞–¥–Ω–æ–π</div>
            <div class="photo-upload"><input type="file" id="invoicePhoto" accept="image/*,application/pdf" onchange="previewPhoto(this)">
                <div class="upload-icon">üìÑ</div><p>–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ –Ω–∞–∫–ª–∞–¥–Ω–æ–π</p><p style="font-size:12px;margin-top:4px">JPG, PNG, PDF ‚Äî –¥–æ 20MB</p>
                <img id="photoPreview" class="photo-preview">
            </div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:12px">
            <button class="btn btn-secondary" onclick="resetCreateForm()">–û—á–∏—Å—Ç–∏—Ç—å</button>
            <button class="btn btn-primary" onclick="createItem()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ —Å–æ–∑–¥–∞—Ç—å QR</button>
        </div>
    </div>

    <!-- ITEMS LIST -->
    <div class="page" id="page-items">
        <div class="page-header">
            <div><div class="page-title">–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</div><div class="page-subtitle">–í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ</div></div>
            <button class="btn btn-primary" onclick="showPage('create-item')">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
        </div>
        <div class="card">
            <div class="table-controls">
                <input type="text" class="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, SKU, –∞—Ä—Ç–∏–∫—É–ª—É..." oninput="searchItems(this.value)">
                <select class="form-control" style="width:180px" onchange="filterByCategory(this.value)" id="categoryFilter"><option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option></select>
                <button class="btn btn-secondary btn-sm" onclick="loadItems()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            <table><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>SKU</th><th>–ê—Ä—Ç–∏–∫—É–ª</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–ö–æ–ª-–≤–æ</th><th>–ï–¥.</th><th>–õ–æ–∫–∞—Ü–∏—è</th><th>QR</th></tr></thead>
            <tbody id="itemsTable"><tr><td colspan="8" class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody></table>
        </div>
    </div>

    <!-- LOCATIONS -->
    <div class="page" id="page-locations">
        <div class="page-header"><div><div class="page-title">–õ–æ–∫–∞—Ü–∏–∏ —Å–∫–ª–∞–¥–∞</div><div class="page-subtitle">–°—Ç–µ–ª–ª–∞–∂–∏, –ø–æ–ª–∫–∏, —è—á–µ–π–∫–∏</div></div></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
            <div class="card">
                <div class="card-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é</div>
                <div id="locationAlert" class="alert"></div>
                <div class="form-group" style="margin-bottom:12px"><label>–ö–æ–¥ * (A-01, B-02)</label><input type="text" id="locCode" class="form-control" placeholder="A-01"></div>
                <div class="form-group" style="margin-bottom:12px"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><input type="text" id="locDesc" class="form-control" placeholder="–°—Ç–µ–ª–ª–∞–∂ A, –ø–æ–ª–∫–∞ 1"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px">
                    <div class="form-group"><label>–†—è–¥</label><input type="text" id="locRow" class="form-control" placeholder="A"></div>
                    <div class="form-group"><label>–°–µ–∫—Ü–∏—è</label><input type="text" id="locSection" class="form-control" placeholder="1"></div>
                    <div class="form-group"><label>–ü–æ–ª–∫–∞</label><input type="text" id="locShelf" class="form-control" placeholder="2"></div>
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="createLocation()">üìç –°–æ–∑–¥–∞—Ç—å –ª–æ–∫–∞—Ü–∏—é –∏ QR</button>
            </div>
            <div class="card">
                <div class="card-title">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ª–æ–∫–∞—Ü–∏–∏</div>
                <table><thead><tr><th>–ö–æ–¥</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>QR</th></tr></thead>
                <tbody id="locationsTable"><tr><td colspan="3" class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody></table>
            </div>
        </div>
    </div>

</div>

<!-- MODALS -->
<div class="modal-overlay" id="successModal">
    <div class="modal"><div class="modal-icon">‚úÖ</div><h3 id="modalTitle">–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω!</h3><p id="modalDesc"></p>
        <img id="modalQR" class="qr-preview" src="" alt="QR">
        <div style="display:flex;gap:10px;justify-content:center">
            <a id="modalDownload" href="#" download class="btn btn-success">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å QR</a>
            <button class="btn btn-secondary" onclick="closeModal();showPage('create-item')">‚ûï –ï—â—ë</button>
            <button class="btn btn-secondary" onclick="closeModal();showPage('items')">üìã –ö —Å–ø–∏—Å–∫—É</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="scannerModal">
    <div class="modal scanner-modal" style="width:460px">
        <div style="font-size:28px;margin-bottom:10px">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —è—á–µ–π–∫–∏</div>
        <p style="color:#666;font-size:13px;margin-bottom:14px">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR –∫–æ–¥ —è—á–µ–π–∫–∏ —Å–∫–ª–∞–¥–∞</p>
        <div class="scanner-video-wrap"><video id="assemblyVideo" playsinline autoplay muted></video><canvas id="assemblyCanvas"></canvas><div class="scanner-frame-overlay"><div class="scanner-frame-box"></div></div></div>
        <div class="scanner-result" id="assemblyScanResult"></div>
        <button class="btn btn-secondary" onclick="closeScanner()">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<div class="modal-overlay" id="orderQrModal">
    <div class="modal"><div class="modal-icon">üì±</div><h3>QR –∫–æ–¥ –∑–∞—è–≤–∫–∏</h3>
        <p id="orderQrDesc" style="margin-bottom:14px"></p>
        <img id="orderQrImg" class="issue-qr-img" src="" alt="QR –∑–∞—è–≤–∫–∏">
        <div style="display:flex;gap:10px;justify-content:center">
            <a id="orderQrDownload" href="#" download class="btn btn-success btn-sm">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å</a>
            <button class="btn btn-secondary" onclick="closeOrderQrModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
const API='/api';
let token=null,currentUser=null,allItems=[],allOrders=[],searchTimeout=null,currentOrder=null;
let assemblyStream=null,issuanceStream=null,assemblyScanning=false,issuanceScanning=false;

async function adminLogin(){
    const u=document.getElementById('authUsername').value,p=document.getElementById('authPassword').value,a=document.getElementById('authAlert');
    try{
        const res=await fetch(`${API}/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
        const d=await res.json();
        if(d.success){
            token=d.token;currentUser=d.username;
            document.getElementById('authOverlay').style.display='none';
            document.getElementById('sidebar').style.display='flex';
            document.getElementById('mainContent').style.display='block';
            document.getElementById('sidebarUser').textContent=currentUser;
            loadDashboard();loadLocationsForSelect();loadCategories();loadOrders();
        }else{showAlert(a,d.error||'–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å','error');}
    }catch(e){showAlert(a,'–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è','error');}
}
function adminLogout(){stopAssemblyScanner();stopIssuanceScan();token=null;document.getElementById('sidebar').style.display='none';document.getElementById('mainContent').style.display='none';document.getElementById('authOverlay').style.display='flex';}

function showPage(n){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
    document.getElementById('page-'+n)?.classList.add('active');
    document.getElementById('nav-'+n)?.classList.add('active');
    if(n==='dashboard')loadDashboard();
    if(n==='orders')loadOrders();
    if(n==='items')loadItems();
    if(n==='locations')loadLocations();
    if(n!=='issuance')stopIssuanceScan();
}

async function loadDashboard(){
    try{
        const[iR,lR,oR]=await Promise.all([fetch(`${API}/admin/items`),fetch(`${API}/admin/locations`),fetch(`${API}/mechanic/orders`)]);
        const iD=await iR.json(),lD=await lR.json(),oD=await oR.json();
        const items=iD.items||[],orders=oD.orders||[];
        const low=items.filter(i=>i.quantity<5);
        const pending=orders.filter(o=>['pending','collecting'].includes(o.status));
        const ready=orders.filter(o=>o.status==='ready');
        document.getElementById('statItems').textContent=items.length;
        document.getElementById('statLocations').textContent=(lD.locations||[]).length;
        document.getElementById('statLow').textContent=low.length;
        document.getElementById('statOrders').textContent=pending.length;
        document.getElementById('statReady').textContent=ready.length;
        const urgent=orders.filter(o=>o.priority==='urgent'&&o.status!=='issued');
        const urgEl=document.getElementById('urgentOrdersList');
        urgEl.innerHTML=urgent.length?urgent.map(o=>`<div class="order-row" onclick="openAssembly('${o.id}')"><div class="order-priority-dot urgent"></div><div class="order-info"><div class="order-title">${o.equipment} ‚Äî ${o.work_type}</div><div class="order-meta">${o.id} ¬∑ ${o.items_count||0} –ø–æ–∑.</div></div><span class="badge badge-red">–°—Ä–æ—á–Ω–æ</span></div>`).join(''):'<div class="empty-state" style="padding:20px"><div class="icon">‚úÖ</div>–°—Ä–æ—á–Ω—ã—Ö –Ω–µ—Ç</div>';
        document.getElementById('lowStockTable').innerHTML=low.slice(0,8).map(i=>`<tr><td><strong>${i.name}</strong></td><td><span class="qty low">${i.quantity} ${i.unit||'—à—Ç'}</span></td><td>${i.location?.code?`<span class="badge badge-blue">${i.location.code}</span>`:'‚Äî'}</td></tr>`).join('')||'<tr><td colspan="3" style="text-align:center;color:#aaa;padding:16px">–í—Å—ë —Ö–æ—Ä–æ—à–æ</td></tr>';
    }catch(e){console.error(e);}
}

async function loadOrders(){
    try{
        const res=await fetch(`${API}/mechanic/orders`),data=await res.json();
        allOrders=(data.orders||[]).sort((a,b)=>{
            if(a.priority==='urgent'&&b.priority!=='urgent')return -1;
            if(b.priority==='urgent'&&a.priority!=='urgent')return 1;
            return new Date(b.created_at)-new Date(a.created_at);
        });
        renderOrders(allOrders);
        const cnt=allOrders.filter(o=>['pending','collecting'].includes(o.status)).length;
        const b=document.getElementById('pendingBadge');b.textContent=cnt;b.style.display=cnt>0?'inline':'none';
    }catch(e){renderOrders([]);}
}
function filterOrders(s,btn){document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderOrders(s?allOrders.filter(o=>o.status===s):allOrders);}
function renderOrders(orders){
    const c=document.getElementById('ordersList');
    if(!orders.length){c.innerHTML='<div class="empty-state"><div class="icon">üìã</div><p>–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</p></div>';return;}
    const sMap={pending:{l:'–û–∂–∏–¥–∞–µ—Ç',b:'badge-blue'},collecting:{l:'–í —Å–±–æ—Ä–∫–µ',b:'badge-orange'},ready:{l:'–ì–æ—Ç–æ–≤–æ',b:'badge-green'},issued:{l:'–í—ã–¥–∞–Ω–æ',b:'badge-purple'},draft:{l:'–ß–µ—Ä–Ω–æ–≤–∏–∫',b:'badge-gray'}};
    c.innerHTML=orders.map(o=>{
        const s=sMap[o.status]||sMap.pending;
        return `<div class="order-row" onclick="openAssembly('${o.id}')">
            <div class="order-priority-dot ${o.priority}"></div>
            <div class="order-info"><div class="order-title">${o.priority==='urgent'?'üî¥ ':''}${o.equipment} ‚Äî ${o.work_type}</div>
            <div class="order-meta">${o.id} ¬∑ ‚Ññ ${o.equipment_number} ¬∑ ${o.items_count||0} –ø–æ–∑. ¬∑ ${formatDate(o.created_at)}</div></div>
            <div class="order-actions">
                <span class="badge ${s.b}">${s.l}</span>
                ${o.status==='pending'?`<button class="btn btn-warning btn-sm" onclick="event.stopPropagation();startCollecting('${o.id}')">üîß –ù–∞—á–∞—Ç—å</button>`:''}
                ${o.status==='collecting'?`<button class="btn btn-blue btn-sm" onclick="event.stopPropagation();openAssembly('${o.id}')">üì¶ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>`:''}
                ${o.status==='ready'?`<button class="btn btn-success btn-sm" onclick="event.stopPropagation();showOrderQR('${o.id}')">üì± QR –≤—ã–¥–∞—á–∏</button>`:''}
            </div></div>`;
    }).join('');
}
async function startCollecting(id){try{await fetch(`${API}/mechanic/order/${id}/status`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:'collecting'})});}catch(e){}await loadOrders();openAssembly(id);}

async function openAssembly(orderId){
    let order=allOrders.find(o=>o.id===orderId);
    if(!order){await loadOrders();order=allOrders.find(o=>o.id===orderId);}
    if(!order)return;
    currentOrder=JSON.parse(JSON.stringify(order));
    document.getElementById('assemblyTitle').textContent=`${order.equipment} ‚Äî ${order.work_type}`;
    document.getElementById('assemblySubtitle').textContent=`${order.id} ¬∑ ‚Ññ ${order.equipment_number}`;
    const sMap={pending:'badge-blue',collecting:'badge-orange',ready:'badge-green',issued:'badge-purple'};
    const sLabel={pending:'–û–∂–∏–¥–∞–µ—Ç',collecting:'–í —Å–±–æ—Ä–∫–µ',ready:'–ì–æ—Ç–æ–≤–æ',issued:'–í—ã–¥–∞–Ω–æ'};
    document.getElementById('assemblyBadge').innerHTML=`<span class="badge ${sMap[order.status]||'badge-gray'}">${sLabel[order.status]||order.status}</span>`;
    renderAssemblyItems(currentOrder.items||[]);updateProgress();
    document.querySelector('#page-assembly .btn-warning').disabled=false;
    showPage('assembly');
}
function renderAssemblyItems(items){
    const c=document.getElementById('assemblyItemsList');
    if(!items.length){c.innerHTML='<div class="empty-state"><div class="icon">üì¶</div><p>–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π</p></div>';return;}
    c.innerHTML=items.map((item,i)=>`
        <div class="assembly-item ${item.collect_status||''}" id="asm-item-${i}">
            <div class="assembly-item-check ${item.collect_status==='collected'?'done':item.collect_status==='not-found'?'nf':''}" onclick="toggleItemStatus(${i})">
                ${item.collect_status==='collected'?'‚úì':item.collect_status==='not-found'?'‚úï':''}
            </div>
            <div class="assembly-item-info">
                <div class="assembly-item-name">${item.name}</div>
                <div class="assembly-item-meta">${item.part_number?`–ê—Ä—Ç: <strong>${item.part_number}</strong> ¬∑ `:''}${item.justification||''}</div>
                <div style="margin-top:6px;display:flex;gap:8px;align-items:center">
                    ${item.item_id?`<span class="assembly-item-location">üìç ${item.location_code||'—É—Ç–æ—á–Ω–∏—Ç—å'}</span>`:'<span class="badge badge-yellow">‚úèÔ∏è –†—É—á–Ω–æ–π –≤–≤–æ–¥</span>'}
                    ${item.photo_url?`<img src="${item.photo_url}" style="height:28px;border-radius:4px;cursor:pointer" onclick="window.open('${item.photo_url}')">` :''}
                </div>
            </div>
            <div class="assembly-item-qty"><div class="need">${item.quantity}</div><div class="unit">${item.unit||'—à—Ç'}</div></div>
            <div class="assembly-item-actions">
                <button class="btn btn-success btn-sm" onclick="markItem(${i},'collected')">‚úì –°–æ–±—Ä–∞–Ω–æ</button>
                <button class="btn btn-sm" style="background:#fef2f2;color:#dc2626" onclick="markItem(${i},'not-found')">‚úï –ù–µ—Ç</button>
            </div>
        </div>`).join('');
}
function markItem(i,s){if(!currentOrder?.items)return;currentOrder.items[i].collect_status=s;renderAssemblyItems(currentOrder.items);updateProgress();}
function toggleItemStatus(i){
    if(!currentOrder?.items)return;
    const item=currentOrder.items[i];
    item.collect_status=!item.collect_status?'collected':item.collect_status==='collected'?'not-found':'';
    renderAssemblyItems(currentOrder.items);updateProgress();
}
function updateProgress(){
    const items=currentOrder?.items||[];
    const col=items.filter(i=>i.collect_status==='collected').length;
    const nf=items.filter(i=>i.collect_status==='not-found').length;
    const pend=items.length-col-nf;
    const pct=items.length?Math.round((col+nf)/items.length*100):0;
    document.getElementById('progressBar').style.width=pct+'%';
    document.getElementById('progressText').textContent=`${col+nf} –∏–∑ ${items.length}`;
    document.getElementById('collectedCount').textContent=col;
    document.getElementById('notFoundCount').textContent=nf;
    document.getElementById('pendingCount').textContent=pend;
    const allDone=pend===0&&items.length>0,allCol=col===items.length&&items.length>0;
    document.getElementById('btnFinishAssembly').disabled=!allDone||allCol;
    document.getElementById('btnFinishAssembly').style.display=allCol?'none':'inline-flex';
    document.getElementById('btnCompleteAssembly').style.display=allCol?'inline-flex':'none';
}
async function completeAssembly(){if(!currentOrder)return;try{await fetch(`${API}/mechanic/order/${currentOrder.id}/status`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:'ready'})});}catch(e){}await loadOrders();showOrderQR(currentOrder.id);}
async function finishAssembly(){
    if(!currentOrder)return;
    const nf=(currentOrder.items||[]).filter(i=>i.collect_status==='not-found');
    if(!confirm(nf.length?`${nf.length} –ø–æ–∑–∏—Ü–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–±–æ—Ä–∫—É?`:'–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–±–æ—Ä–∫—É?'))return;
    try{await fetch(`${API}/mechanic/order/${currentOrder.id}/status`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:'ready'})});}catch(e){}
    await loadOrders();showOrderQR(currentOrder.id);
}
async function showOrderQR(orderId){
    try{await fetch(`${API}/mechanic/order/${orderId}/qr`,{method:'POST'});}catch(e){}
    const qrUrl=`/qrcodes/order_${orderId}.png?t=${Date.now()}`;
    document.getElementById('orderQrDesc').textContent=`–ó–∞—è–≤–∫–∞ ${orderId} –≥–æ—Ç–æ–≤–∞ –∫ –≤—ã–¥–∞—á–µ`;
    document.getElementById('orderQrImg').src=qrUrl;
    document.getElementById('orderQrDownload').href=qrUrl;
    document.getElementById('orderQrDownload').download=`qr_order_${orderId}.png`;
    document.getElementById('orderQrModal').classList.add('show');
}
function closeOrderQrModal(){document.getElementById('orderQrModal').classList.remove('show');}

function startScanForAssembly(){document.getElementById('scannerModal').classList.add('show');startAssemblyScanner();}
function closeScanner(){document.getElementById('scannerModal').classList.remove('show');stopAssemblyScanner();}
async function startAssemblyScanner(){
    try{
        assemblyStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
        const v=document.getElementById('assemblyVideo');v.srcObject=assemblyStream;await v.play();
        assemblyScanning=true;scanAssemblyQR();
    }catch(e){alert('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: '+e.message);}
}
function stopAssemblyScanner(){assemblyScanning=false;if(assemblyStream){assemblyStream.getTracks().forEach(t=>t.stop());assemblyStream=null;}}
function scanAssemblyQR(){
    if(!assemblyScanning)return;
    const v=document.getElementById('assemblyVideo'),c=document.getElementById('assemblyCanvas'),ctx=c.getContext('2d');
    if(v.videoWidth>0){c.width=v.videoWidth;c.height=v.videoHeight;ctx.drawImage(v,0,0);
        const code=jsQR(ctx.getImageData(0,0,c.width,c.height).data,c.width,c.height);
        if(code&&code.data.startsWith('LOC:')){
            const r=document.getElementById('assemblyScanResult');r.textContent=`‚úÖ –Ø—á–µ–π–∫–∞: ${code.data.substring(4)}`;r.classList.add('show');
            stopAssemblyScanner();setTimeout(closeScanner,1500);return;
        }
    }
    requestAnimationFrame(scanAssemblyQR);
}

async function startIssuanceScan(){
    try{
        issuanceStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
        const v=document.getElementById('issuanceVideo');v.srcObject=issuanceStream;await v.play();
        document.getElementById('issuanceScannerWrap').style.display='block';
        document.getElementById('btnStartIssuanceScan').style.display='none';
        document.getElementById('btnStopIssuanceScan').style.display='block';
        issuanceScanning=true;scanIssuanceQR();
    }catch(e){alert('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: '+e.message);}
}
function stopIssuanceScan(){
    issuanceScanning=false;
    if(issuanceStream){issuanceStream.getTracks().forEach(t=>t.stop());issuanceStream=null;}
    document.getElementById('issuanceScannerWrap').style.display='none';
    document.getElementById('btnStartIssuanceScan').style.display='block';
    document.getElementById('btnStopIssuanceScan').style.display='none';
}
function scanIssuanceQR(){
    if(!issuanceScanning)return;
    const v=document.getElementById('issuanceVideo'),c=document.getElementById('issuanceCanvas'),ctx=c.getContext('2d');
    if(v.videoWidth>0){c.width=v.videoWidth;c.height=v.videoHeight;ctx.drawImage(v,0,0);
        const code=jsQR(ctx.getImageData(0,0,c.width,c.height).data,c.width,c.height);
        if(code&&code.data.startsWith('WO:')){
            const r=document.getElementById('issuanceScanResult');r.textContent=`‚úÖ –ó–∞—è–≤–∫–∞: ${code.data.substring(3)}`;r.classList.add('show');
            stopIssuanceScan();lookupOrderForIssuance(code.data.substring(3));return;
        }
    }
    requestAnimationFrame(scanIssuanceQR);
}
async function lookupOrderForIssuance(orderId){
    if(!orderId)return;
    const empty=document.getElementById('issuanceEmpty'),card=document.getElementById('issuanceOrderCard');
    try{
        const res=await fetch(`${API}/mechanic/order/${orderId}`),data=await res.json();
        if(!data.success){empty.style.display='block';card.style.display='none';return;}
        const o=data.order;
        document.getElementById('iss-id').textContent=o.id;
        document.getElementById('iss-equipment').textContent=`${o.equipment} (${o.equipment_number})`;
        document.getElementById('iss-worktype').textContent=o.work_type;
        document.getElementById('iss-items').textContent=(o.items||[]).length+' –ø–æ–∑–∏—Ü–∏–π';
        const sL={pending:'‚è≥ –û–∂–∏–¥–∞–µ—Ç',collecting:'üîß –í —Å–±–æ—Ä–∫–µ',ready:'‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –≤—ã–¥–∞—á–µ',issued:'üì§ –í—ã–¥–∞–Ω–æ'};
        document.getElementById('iss-status').innerHTML=`<span class="badge ${o.status==='ready'?'badge-green':o.status==='issued'?'badge-purple':'badge-orange'}">${sL[o.status]||o.status}</span>`;
        const act=document.getElementById('issuanceActions');
        if(o.status==='ready'){
            document.getElementById('issuanceIcon').textContent='‚úÖ';
            document.getElementById('issuanceOrderTitle').textContent='–ó–∞—è–≤–∫–∞ –≥–æ—Ç–æ–≤–∞ –∫ –≤—ã–¥–∞—á–µ!';
            act.innerHTML=`<button class="btn btn-success" style="width:100%" onclick="confirmIssuance('${o.id}')">ü§ù –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–¥–∞—á—É –∏ —Å–ø–∏—Å–∞—Ç—å –æ—Å—Ç–∞—Ç–∫–∏</button>`;
        }else if(o.status==='issued'){
            document.getElementById('issuanceIcon').textContent='üì§';
            document.getElementById('issuanceOrderTitle').textContent='–£–∂–µ –≤—ã–¥–∞–Ω–æ';
            act.innerHTML=`<span class="badge badge-purple" style="font-size:14px;padding:8px 16px">–ó–∞—è–≤–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞</span>`;
        }else{
            document.getElementById('issuanceIcon').textContent='‚è≥';
            document.getElementById('issuanceOrderTitle').textContent='–ó–∞—è–≤–∫–∞ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤–∞';
            act.innerHTML=`<p style="color:#888;font-size:14px">${sL[o.status]||o.status}</p>`;
        }
        empty.style.display='none';card.style.display='block';
    }catch(e){empty.style.display='block';card.style.display='none';}
}
async function confirmIssuance(orderId){
    if(!confirm('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–¥–∞—á—É? –û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ –±—É–¥—É—Ç —Å–ø–∏—Å–∞–Ω—ã.'))return;
    try{await fetch(`${API}/mechanic/order/${orderId}/issue`,{method:'POST',headers:{'Content-Type':'application/json'}});}catch(e){}
    await loadOrders();
    document.getElementById('issuanceIcon').textContent='üéâ';
    document.getElementById('issuanceOrderTitle').textContent='–í—ã–¥–∞—á–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!';
    document.getElementById('issuanceActions').innerHTML=`<p style="color:#10b981;font-weight:600">–û—Å—Ç–∞—Ç–∫–∏ —Å–ø–∏—Å–∞–Ω—ã. –ó–∞—è–≤–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞.</p>`;
    document.getElementById('iss-status').innerHTML=`<span class="badge badge-purple">üì§ –í—ã–¥–∞–Ω–æ</span>`;
}

async function createItem(){
    const a=document.getElementById('createAlert'),name=document.getElementById('itemName').value.trim(),sku=document.getElementById('itemSku').value.trim();
    if(!name||!sku){showAlert(a,'–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –ù–∞–∑–≤–∞–Ω–∏–µ –∏ SKU','error');return;}
    const payload={name,sku,description:document.getElementById('itemDescription').value,quantity:parseInt(document.getElementById('itemQuantity').value)||0,unit:document.getElementById('itemUnit').value,category:document.getElementById('itemCategory').value,part_number:document.getElementById('itemPartNumber').value,batch_number:document.getElementById('itemBatchNumber').value,batch_quantity:parseInt(document.getElementById('itemBatchQty').value)||0,batch_arrived_at:document.getElementById('itemArrivedAt').value||'',location_id:document.getElementById('itemLocation').value};
    try{
        const res=await fetch(`${API}/admin/item`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}),data=await res.json();
        if(data.success){
            const f=document.getElementById('invoicePhoto').files[0];
            if(f){const fm=new FormData();fm.append('photo',f);await fetch(`${API}/admin/item/${data.item.id}/photo`,{method:'POST',body:fm});}
            document.getElementById('modalTitle').textContent=`–¢–æ–≤–∞—Ä "${data.item.name}" —Å–æ–∑–¥–∞–Ω!`;
            document.getElementById('modalDesc').textContent=`ID: ${data.item.id} ¬∑ SKU: ${data.item.sku}`;
            document.getElementById('modalQR').src=data.qr_url;
            document.getElementById('modalDownload').href=data.qr_url;
            document.getElementById('modalDownload').download=`qr_${data.item.id}.png`;
            document.getElementById('successModal').classList.add('show');
            resetCreateForm();loadCategories();
        }else{showAlert(a,data.error||'–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è','error');}
    }catch(e){showAlert(a,'–û—à–∏–±–∫–∞: '+e.message,'error');}
}
function resetCreateForm(){['itemName','itemSku','itemPartNumber','itemCategory','itemDescription','itemBatchNumber','itemBatchQty','itemQuantity','itemArrivedAt'].forEach(id=>document.getElementById(id).value='');document.getElementById('itemUnit').value='—à—Ç';document.getElementById('itemLocation').value='';document.getElementById('invoicePhoto').value='';document.getElementById('photoPreview').style.display='none';hideAlert(document.getElementById('createAlert'));}
function previewPhoto(input){const p=document.getElementById('photoPreview');if(input.files?.[0]?.type.startsWith('image/')){const r=new FileReader();r.onload=e=>{p.src=e.target.result;p.style.display='block';};r.readAsDataURL(input.files[0]);}}
async function loadItems(search='',category=''){let url=`${API}/admin/items?`;if(search)url+=`search=${encodeURIComponent(search)}&`;if(category)url+=`category=${encodeURIComponent(category)}`;try{const res=await fetch(url),data=await res.json();allItems=data.items||[];renderItemsTable(allItems);}catch(e){}}
function renderItemsTable(items){const t=document.getElementById('itemsTable');if(!items.length){t.innerHTML='<tr><td colspan="8" class="empty-state"><div class="icon">üì¶</div>–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</td></tr>';return;}t.innerHTML=items.map(i=>`<tr><td><strong>${i.name}</strong><br><small style="color:#aaa">${i.description||''}</small></td><td><span class="badge badge-gray">${i.sku}</span></td><td style="color:#888">${i.part_number||'‚Äî'}</td><td>${i.category?`<span class="badge badge-blue">${i.category}</span>`:'‚Äî'}</td><td><span class="qty ${i.quantity<5?'low':''}">${i.quantity}</span></td><td>${i.unit||'—à—Ç'}</td><td>${i.location?.code?`<span class="badge badge-green">${i.location.code}</span>`:'‚Äî'}</td><td><a href="/api/admin/item/${i.id}/qr" download class="btn btn-sm btn-secondary">üì• QR</a></td></tr>`).join('');}
function searchItems(v){clearTimeout(searchTimeout);searchTimeout=setTimeout(()=>loadItems(v,document.getElementById('categoryFilter').value),300);}
function filterByCategory(c){loadItems(document.querySelector('.search-input').value,c);}
async function loadLocations(){try{const res=await fetch(`${API}/admin/locations`),data=await res.json();const t=document.getElementById('locationsTable'),locs=data.locations||[];t.innerHTML=locs.length?locs.map(l=>`<tr><td><strong>${l.code}</strong></td><td style="color:#666">${l.description||'‚Äî'}</td><td><a href="/api/admin/location/${l.id}/qr" download class="btn btn-sm btn-secondary">üì• QR</a></td></tr>`).join(''):'<tr><td colspan="3" class="empty-state">–ù–µ—Ç –ª–æ–∫–∞—Ü–∏–π</td></tr>';}catch(e){}}
async function loadLocationsForSelect(){try{const res=await fetch(`${API}/admin/locations`),data=await res.json();const sel=document.getElementById('itemLocation');(data.locations||[]).forEach(l=>{const o=document.createElement('option');o.value=l.id;o.textContent=`${l.code} ‚Äî ${l.description||''}`;sel.appendChild(o);});}catch(e){}}
async function createLocation(){const a=document.getElementById('locationAlert'),code=document.getElementById('locCode').value.trim();if(!code){showAlert(a,'–£–∫–∞–∂–∏—Ç–µ –∫–æ–¥','error');return;}try{const res=await fetch(`${API}/admin/location`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code,description:document.getElementById('locDesc').value,row:document.getElementById('locRow').value,section:document.getElementById('locSection').value,shelf:document.getElementById('locShelf').value})}),data=await res.json();if(data.success){showAlert(a,`–õ–æ–∫–∞—Ü–∏—è ${code} —Å–æ–∑–¥–∞–Ω–∞!`,'success');['locCode','locDesc','locRow','locSection','locShelf'].forEach(id=>document.getElementById(id).value='');loadLocations();const sel=document.getElementById('itemLocation'),opt=document.createElement('option');opt.value=data.location.id;opt.textContent=`${data.location.code} ‚Äî ${data.location.description||''}`;sel.appendChild(opt);}else{showAlert(a,data.error,'error');}}catch(e){showAlert(a,'–û—à–∏–±–∫–∞: '+e.message,'error');}}
async function loadCategories(){try{const res=await fetch(`${API}/admin/categories`),data=await res.json();const cats=data.categories||[];document.getElementById('categoryList').innerHTML=cats.map(c=>`<option value="${c}">`).join('');const sel=document.getElementById('categoryFilter'),cur=sel.value;sel.innerHTML='<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>'+cats.map(c=>`<option value="${c}" ${c===cur?'selected':''}>${c}</option>`).join('');}catch(e){}}

function showAlert(el,msg,type){el.textContent=msg;el.className=`alert alert-${type} show`;}
function hideAlert(el){if(el){el.className='alert';el.textContent='';}}
function closeModal(){document.getElementById('successModal').classList.remove('show');}
function formatDate(s){if(!s)return '‚Äî';return new Date(s).toLocaleString('ru-RU',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});}
document.addEventListener('keydown',e=>{
    if(e.key==='Enter'&&document.getElementById('authOverlay').style.display!=='none')adminLogin();
    if(e.key==='Escape'){closeModal();closeScanner();closeOrderQrModal();}
});
</script>
</body>
</html>